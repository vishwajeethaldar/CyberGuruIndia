<%- include('../partials/head', { title }) %>
<%- include('../partials/navbar') %>
<%- include('../partials/admin-submenu') %>
<%- include('../partials/alerts') %>

<main class="container py-4" style="max-width: 900px;">
  <h1 class="h3 mb-3"><%= blog ? 'Edit Blog' : 'Add Blog' %></h1>
  <form method="POST" action="<%= action %>" enctype="multipart/form-data" class="card card-body shadow-sm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input class="form-control" type="text" name="title" value="<%= blog ? blog.title : '' %>" required maxlength="160" />
    </div>
    <div class="mb-3">
      <label class="form-label">Content</label>
      <textarea class="form-control" name="content" rows="8" required maxlength="10000"><%- blog ? blog.content : '' %></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Category</label>
      <select class="form-select" name="category" required>
        <% categories.forEach((category) => { %>
          <option value="<%= category._id %>" <%= blog && String(blog.category) === String(category._id) ? 'selected' : '' %>><%= category.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Thumbnail (optional)</label>
      <% if (blog && blog.thumbnailPath) { %>
        <div class="mb-2">
          <div class="d-flex align-items-start gap-3">
            <img src="<%= blog.thumbnailPath %>" alt="Current thumbnail" class="rounded border" style="width: 200px; height: auto; max-height: 150px; object-fit: cover;" />
            <div>
              <p class="mb-2 text-muted small">Current thumbnail</p>
              <button type="button" class="btn btn-sm btn-danger" onclick="removeThumbnail('<%= blog._id %>')">ğŸ—‘ï¸ Remove Thumbnail</button>
            </div>
          </div>
        </div>
      <% } %>
      <input class="form-control" type="file" name="thumbnail" accept="image/*" />
      <small class="form-text text-muted">Upload a new thumbnail to replace the current one</small>
    </div>
    <% if (blog && blog.slug) { %>
      <div class="mb-3">
        <label class="form-label">Share</label>
        <button class="btn btn-outline-secondary js-copy-share" type="button" data-share-url="<%= siteBaseUrl %>/blogs/<%= blog.slug %>">ğŸ”— Share</button>
      </div>
    <% } %>
    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" name="discussionEnabled" id="blogDiscussionEnabled" <%= !blog || blog.discussionEnabled ? 'checked' : '' %> />
      <label class="form-check-label" for="blogDiscussionEnabled">Enable discussion</label>
    </div>
    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-outline-secondary" href="/admin/blogs">Cancel</a>
    </div>
  </form>
</main>

<script>
function removeThumbnail(blogId) {
  if (!confirm('Are you sure you want to remove this thumbnail?')) {
    return;
  }

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  fetch(`/admin/blogs/${blogId}/thumbnail`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken,
    },
    credentials: 'same-origin',
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Failed to remove thumbnail: ' + (data.message || 'Unknown error'));
    }
  })
  .catch(error => {
    alert('Error removing thumbnail: ' + error.message);
  });
}
</script>

<%- include('../partials/footer') %>
