<%- include('../partials/head', { title }) %>
<%- include('../partials/navbar') %>
<%- include('../partials/admin-submenu') %>
<%- include('../partials/alerts') %>

<main class="container py-4" style="max-width: 850px;">
  <h1 class="h3 mb-3"><%= video ? 'Edit Video' : 'Add Video' %></h1>
  <form method="POST" action="<%= action %>" enctype="multipart/form-data" class="card card-body shadow-sm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <div class="mb-3">
      <label class="form-label d-flex align-items-center gap-2">
        <span aria-hidden="true">ğŸ–¼ï¸</span>
        <span>Title</span>
      </label>
      <input class="form-control" type="text" name="title" value="<%= video ? video.title : '' %>" required maxlength="160" />
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" rows="5" required maxlength="3000"><%- video ? video.description : '' %></textarea>
    </div>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">YouTube URL or ID</label>
        <input class="form-control" type="text" name="youtubeId" value="<%= video ? video.youtubeId : '' %>" required />
      </div>
      <div class="col-md-6">
        <label class="form-label">Category</label>
        <select class="form-select" name="category" required>
          <% categories.forEach((category) => { %>
            <option value="<%= category._id %>" <%= video && String(video.category) === String(category._id) ? 'selected' : '' %>><%= category.name %></option>
          <% }) %>
        </select>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Thumbnail (optional)</label>
      <% if (video && video.thumbnailPath) { %>
        <div class="mb-2">
          <div class="d-flex align-items-start gap-3">
            <img src="<%= video.thumbnailPath %>" alt="Current thumbnail" class="rounded border" style="width: 200px; height: auto; max-height: 150px; object-fit: cover;" />
            <div>
              <p class="mb-2 text-muted small">Current thumbnail</p>
              <button type="button" class="btn btn-sm btn-danger" onclick="removeThumbnail('<%= video._id %>')">ğŸ—‘ï¸ Remove Thumbnail</button>
            </div>
          </div>
        </div>
      <% } %>
      <input class="form-control" type="file" name="thumbnail" accept="image/*" />
      <small class="form-text text-muted">Upload a new thumbnail to replace the current one</small>
    </div>
    <div class="mt-3">
      <label class="form-label">Share Link</label>
      <% if (video && video.slug) { %>
        <button
          class="btn btn-outline-secondary js-copy-share"
          type="button"
          data-share-url="<%= siteBaseUrl %>/videos/<%= video.slug %>"
          aria-label="Share video"
        >ğŸ”— Share</button>
      <% } else { %>
        <p class="text-muted small mb-0">Save video first to enable sharing.</p>
      <% } %>
    </div>
    <div class="form-check mt-3">
      <input class="form-check-input" type="checkbox" name="discussionEnabled" id="discussionEnabled" <%= !video || video.discussionEnabled ? 'checked' : '' %> />
      <label class="form-check-label" for="discussionEnabled">Enable discussion</label>
    </div>
    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn btn-outline-secondary" href="/admin/dashboard">Cancel</a>
    </div>
  </form>
</main>

<script>
function removeThumbnail(videoId) {
  if (!confirm('Are you sure you want to remove this thumbnail?')) {
    return;
  }

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  fetch(`/admin/videos/${videoId}/thumbnail`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken,
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('Failed to remove thumbnail: ' + (data.message || 'Unknown error'));
    }
  })
  .catch(error => {
    alert('Error removing thumbnail: ' + error.message);
  });
}
</script>

<%- include('../partials/footer') %>
